AWSTemplateFormatVersion: '2010-09-09'
Description: Cloudfront for lambda@edge - Liam Raven - 25/11/2020

Parameters:
  ProjectName:
    Description: A unique identifier to allow multiple deployments of the cloudformation (MUST BE THE SAME FOR ENTIRE STACK)
    Type: String

Resources:
  ViewerRequestPolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Comment: "Viewer request policy to enable lambda@edge"
        DefaultTTL: 86400
        MaxTTL: 31536000
        MinTTL: 1
        Name: !Sub "${ProjectName}-viewer-request-policy"
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingBrotli: true
          EnableAcceptEncodingGzip: true
          HeadersConfig:
            HeaderBehavior: whitelist
            Headers:
              - Accept-Language
              - CloudFront-Viewer-Country
          QueryStringsConfig:
            QueryStringBehavior: none
          CookiesConfig:
            CookieBehavior: whitelist
            Cookies:
              - language-region-override

  OriginRequestPolicy:
    Type: AWS::CloudFront::OriginRequestPolicy
    Properties:
      OriginRequestPolicyConfig:
        Comment: "Origin request policy to enable lambda@edge"
        Name: !Sub "${ProjectName}-origin-request-policy"
        HeadersConfig:
          HeaderBehavior: whitelist
          Headers:
            - Accept-Language
            - CloudFront-Viewer-Country
        QueryStringsConfig:
          QueryStringBehavior: none
        CookiesConfig:
          CookieBehavior: whitelist
          Cookies:
            - language-region-override

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        # ...all your other distribution config
        DefaultCacheBehavior:
          LambdaFunctionAssociations:
            - EventType: origin-request
              IncludeBody: false
              LambdaFunctionARN:
                Fn::ImportValue: !Sub "${ProjectName}-origin-request-lambda-arn"
            - EventType: origin-response
              IncludeBody: false
              LambdaFunctionARN:
                Fn::ImportValue: !Sub "${ProjectName}-origin-response-lambda-arn"
          CachePolicyId: !Ref ViewerRequestPolicy
          OriginRequestPolicyId: !Ref OriginRequestPolicy